<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Typing Practice App</title>
    <meta name="theme-color" content="#000000">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', Courier, monospace;
            background: #000; color: #fff; min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .container { background: #000; border: 1px solid #fff; max-width: 800px; width: 100%; padding: 20px; }
        h1 { color: #fff; margin-bottom: 20px; font-size: 16px; font-weight: normal; text-transform: uppercase; letter-spacing: 2px; }
        .setup-section { margin-bottom: 20px; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #fff; background: #000; color: #fff; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical; }
        textarea:focus { outline: none; }
        .button-group { display: flex; gap: 20px; margin-top: 10px; }
        button { background: #000; color: #fff; border: 1px solid #fff; padding: 8px 16px; font-size: 14px; font-family: 'Courier New', monospace; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.1s; }
        button:hover { background: #fff; color: #000; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        button:disabled:hover { background: #000; color: #fff; }
        .typing-section { display: none; }
        .stats { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #fff; padding-bottom: 10px; font-size: 14px; }
        .stat-item { display: flex; gap: 10px; }
        .stat-label { opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-weight: normal; }
        .text-display { background: #000; padding: 20px 0; margin-bottom: 20px; line-height: 1.8; font-size: 16px; font-family: 'Courier New', monospace; min-height: 120px; position: relative; border-top: 1px solid #fff; border-bottom: 1px solid #fff; }
        .char { position: relative; white-space: pre; }
        .char.correct { color: #fff; opacity: 0.5; }
        .char.incorrect { color: #ff0000; background: rgba(255, 0, 0, 0.2); }
        .char.current { text-decoration: underline; text-decoration-thickness: 2px; text-underline-offset: 3px; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1 } 50% { opacity: 0.3 } }
        .typing-input { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #fff; background: #000; color: #fff; font-family: 'Courier New', monospace; position: relative; }
        .typing-input:focus { outline: none; }
        .progress-bar { width: 100%; height: 2px; background: #333; margin: 20px 0; position: relative; }
        .progress-fill { height: 100%; background: #fff; transition: width 0.3s ease; }
        .controls { display: flex; gap: 20px; margin-top: 20px; }
        .completion-message { text-align: left; padding: 20px; border: 1px solid #fff; margin-top: 20px; display: none; }
        .completion-message h2 { font-size: 16px; margin-bottom: 20px; font-weight: normal; text-transform: uppercase; letter-spacing: 2px; }
        .final-stats { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; font-family: 'Courier New', monospace; }
        .final-stat { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #666; }
        .final-stat-label { text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        .final-stat-value { font-weight: normal; }
        /* Accessibility helper */
        .sr-only { position: absolute; left: -9999px; }
        /* ASCII divider */
        .divider { text-align: center; margin: 10px 0; opacity: 0.5; font-size: 12px; letter-spacing: 3px; }
    @media (prefers-reduced-motion: reduce) { .char.current { animation: none; } .progress-fill { transition: none; } }
    .history h3 { font-size: 14px; margin-top: 20px; font-weight: normal; text-transform: uppercase; letter-spacing: 2px; }
        .history ul { list-style: none; margin-top: 10px; display: flex; flex-direction: column; gap: 6px; }
        .history li { display: flex; justify-content: space-between; border-bottom: 1px dotted #333; padding: 6px 0; font-size: 13px; }
        @media (prefers-reduced-motion: reduce) { .char.current { animation: none; } .progress-fill { transition: none; } }
    </style>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='4' y='4' width='56' height='56' rx='6' ry='6' fill='white' stroke='black' stroke-width='3'/%3E%3Ctext x='50%25' y='58%25' font-family='Courier New, monospace' font-size='36' fill='black' text-anchor='middle' dominant-baseline='middle'%3ET%3C/text%3E%3C/svg%3E" />
</head>
<body>
    <div class="container">
        <h1>[ TYPING PRACTICE v1.0 ]</h1>

        <div class="setup-section" id="setupSection">
            <div class="divider">════════════════════════════════════════════════</div>
            <textarea id="textInput" placeholder="> PASTE TEXT HERE"></textarea>
            <div class="button-group">
                <button onclick="startTyping()">[START]</button>
                <button onclick="loadSampleText()">[SAMPLE]</button>
            </div>
        </div>

        <div class="typing-section" id="typingSection">
            <div class="stats">
                <div class="stat-item"><span class="stat-label">WPM:</span><span class="stat-value" id="wpm" aria-live="polite">0</span></div>
                <div class="stat-item"><span class="stat-label">ACC:</span><span class="stat-value" id="accuracy" aria-live="polite">100%</span></div>
                <div class="stat-item"><span class="stat-label">TIME:</span><span class="stat-value" id="time" aria-live="polite">0:00</span></div>
                <div class="stat-item"><span class="stat-label">PROG:</span><span class="stat-value" id="progress" aria-live="polite">0%</span></div>
            </div>

            <div class="progress-bar" id="progressWrap" role="progressbar" aria-label="Typing progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                <div class="progress-fill" id="progressBar"></div>
            </div>

            <div class="text-display" id="textDisplay"></div>

            <label for="typingInput" class="sr-only">Typing input</label>
            <input type="text" class="typing-input" id="typingInput" placeholder="> _" inputmode="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />

            <div class="controls">
                <button onclick="resetTyping()">[RESET]</button>
                <button onclick="newText()">[NEW]</button>
                <button onclick="pauseResume()" id="pauseBtn">[PAUSE]</button>
            </div>
        </div>

        <div class="completion-message" id="completionMessage">
            <h2>[ SESSION COMPLETE ]</h2>
            <div class="divider">════════════════════════════════════════════════</div>
            <div class="final-stats">
                <div class="final-stat"><span class="final-stat-label">WORDS PER MINUTE</span><span class="final-stat-value" id="finalWpm">0</span></div>
                <div class="final-stat"><span class="final-stat-label">ACCURACY</span><span class="final-stat-value" id="finalAccuracy">0%</span></div>
                <div class="final-stat"><span class="final-stat-label">TOTAL TIME</span><span class="final-stat-value" id="finalTime">0:00</span></div>
            </div>
            <div class="divider">════════════════════════════════════════════════</div>
            <div class="button-group">
                <button onclick="resetTyping()">[RETRY]</button>
                <button onclick="newText()">[NEW TEXT]</button>
                <button onclick="copyResults()">[COPY RESULTS]</button>
            </div>
        </div>
        <div id="historySection" class="history" style="display:none">
            <h3>[ PAST SESSIONS ]</h3>
            <ul id="historyList"></ul>
            <div class="button-group" style="margin-top:10px">
                <button onclick="clearHistory()">[CLEAR HISTORY]</button>
            </div>
        </div>
    </div>

    <script>
        let originalText = '';
        let currentPosition = 0;
        let startTime = null;
        let errors = 0;
        let totalKeystrokes = 0; // deprecated (kept for compatibility, not used for accuracy)
        let timer = null;
        let isPaused = false;
        let elapsedTime = 0;
        let displayLineLength = 60; // will be recalculated responsively

        // Treat curly and straight quotes (and other punctuation) as equivalent
        function normChar(ch) {
            if (!ch) return ch;
            if ('\u2019\u2018\u2032\u2035\u02BC\u275B\u275C'.includes(ch)) return "'"; // single quotes
            if ('\u201C\u201D\u2033\u2036\u275D\u275E'.includes(ch)) return '"';      // double quotes
            if ('\u2013\u2014'.includes(ch)) return '-';                                  // en/em dash
            if (ch === '\u00A0') return ' ';                                              // nbsp
            return ch;
        }
        function charsEqual(a, b) { return normChar(a) === normChar(b); }
        function computeErrors(typed) {
            let count = 0;
            for (let i = 0; i < typed.length && i < originalText.length; i++) {
                if (!charsEqual(typed[i], originalText[i])) count++;
            }
            return count;
        }

        function loadSampleText() {
            const sampleText = `The quick brown fox jumps over the lazy dog. This pangram sentence contains every letter of the alphabet at least once. Typing practice helps improve both speed and accuracy. Keep your fingers on the home row and maintain good posture while typing. With consistent practice, you'll see improvement in your typing skills over time.`;
            document.getElementById('textInput').value = sampleText;
            try { localStorage.setItem('tp_text', sampleText); } catch(e) {}
        }

        function startTyping() {
            const textInput = document.getElementById('textInput').value.trim();
            if (!textInput) { alert('Please paste some text first!'); return; }

            try { localStorage.setItem('tp_text', textInput); } catch(e) {}

            originalText = textInput;
            currentPosition = 0; errors = 0; totalKeystrokes = 0; startTime = null; isPaused = false; elapsedTime = 0;

            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('typingSection').style.display = 'block';
            document.getElementById('completionMessage').style.display = 'none';

            setResponsiveWidth(); // compute initial chars-per-line
            document.getElementById('typingInput').disabled = false;
            document.getElementById('typingInput').value = '';
            document.getElementById('typingInput').focus();

            renderText();
            updateStats();
        }

        function calcCharsPerLine() {
            const display = document.getElementById('textDisplay');
            const probe = document.createElement('span');
            probe.textContent = 'M';
            probe.style.visibility = 'hidden';
            display.appendChild(probe);
            const charW = probe.getBoundingClientRect().width || 8;
            display.removeChild(probe);
            const inner = display.clientWidth;
            return Math.max(20, Math.floor(inner / charW));
        }
        function setResponsiveWidth() {
            displayLineLength = calcCharsPerLine();
            renderText();
        }
        window.addEventListener('resize', setResponsiveWidth);

        function renderText() {
            const display = document.getElementById('textDisplay');
            display.innerHTML = '';

            const charsPerLine = displayLineLength;
            const currentLine = Math.floor(currentPosition / charsPerLine);
            const startLine = Math.max(0, currentLine - 1);
            const endLine = currentLine + 2;

            const startChar = startLine * charsPerLine;
            const endChar = Math.min(originalText.length, endLine * charsPerLine);

            for (let i = startChar; i < endChar; i++) {
                const char = originalText[i];
                const span = document.createElement('span');
                span.className = 'char';

                if (i === currentPosition) {
                    span.classList.add('current');
                } else if (i < currentPosition) {
                    const inputEl = document.getElementById('typingInput');
                    const typedSliceLen = inputEl.value.length;
                    const offset = currentPosition - typedSliceLen;
                    const typedChar = inputEl.value[i - offset];
                    if (charsEqual(typedChar, char)) span.classList.add('correct');
                    else span.classList.add('incorrect');
                }

                span.textContent = char;
                display.appendChild(span);

                if ((i + 1 - startChar) % charsPerLine === 0 && i < endChar - 1) {
                    display.appendChild(document.createElement('br'));
                }
            }

            if (endChar < originalText.length) {
                const indicator = document.createElement('div');
                indicator.style.opacity = '0.5';
                indicator.style.marginTop = '10px';
                indicator.textContent = '...';
                display.appendChild(indicator);
            }
        }

        function updateStats() {
            
            let wpm = 0;
            if (startTime && !isPaused) {
                const currentTime = Date.now();
                const timeInMinutes = (currentTime - startTime + elapsedTime) / 60000;
                const typedText = document.getElementById('typingInput').value;
            const typedLen = typedText.length;
            const wordsTyped = typedLen / 5;
                wpm = timeInMinutes > 0 ? Math.round(wordsTyped / timeInMinutes) : 0; // divide-by-zero guard
            }

            const typedEl = document.getElementById('typingInput');
            const typedText = typedEl ? typedEl.value : '';
            const typedLen = typedText.length;
            const accuracy = typedLen > 0 ? Math.round(((typedLen - computeErrors(typedText)) / typedLen) * 100) : 100;
            const progress = Math.round((currentPosition / originalText.length) * 100);

            document.getElementById('wpm').textContent = wpm;
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('progress').textContent = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressWrap').setAttribute('aria-valuenow', String(progress));
            document.getElementById('progressWrap').setAttribute('aria-valuetext', progress + '% complete');

            if (startTime && !isPaused) {
                const totalTime = Date.now() - startTime + elapsedTime;
                const minutes = Math.floor(totalTime / 60000);
                const seconds = Math.floor((totalTime % 60000) / 1000);
                document.getElementById('time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function handleTyping(event) {
            if (isPaused) return;

            const input = event.target;
            const typedText = input.value;

            if (!startTime && typedText.length > 0) {
                startTime = Date.now();
                timer = setInterval(updateStats, 100);
            }

            if (typedText.length < currentPosition) {
                currentPosition = typedText.length;
                renderText();
                updateStats();
                return;
            }

            errors = computeErrors(typedText);

            currentPosition = typedText.length;

            if (currentPosition >= originalText.length) { completeTyping(); return; }

            renderText();
            updateStats();
        }

        function completeTyping() {
            clearInterval(timer);
            isPaused = true;

            const totalTime = Date.now() - startTime + elapsedTime;
            const minutes = Math.floor(totalTime / 60000);
            const seconds = Math.floor((totalTime % 60000) / 1000);
            const wordsTyped = currentPosition / 5;
            const timeInMinutes = totalTime / 60000;
            const wpm = timeInMinutes > 0 ? Math.round(wordsTyped / timeInMinutes) : 0;
            const accuracy = typedLen > 0 ? Math.round(((typedLen - computeErrors(typedText)) / typedLen) * 100) : 100;

            document.getElementById('finalWpm').textContent = wpm;
            document.getElementById('finalAccuracy').textContent = accuracy + '%';
            document.getElementById('finalTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Save and show history
            saveSession(wpm, accuracy, totalTime);
            renderHistory();
            const hist = document.getElementById('historySection'); if (hist) hist.style.display = 'block';

            document.getElementById('typingInput').disabled = true;
            document.getElementById('completionMessage').style.display = 'block';
        }

        function resetTyping() {
            currentPosition = 0; errors = 0; totalKeystrokes = 0; startTime = null; isPaused = false; elapsedTime = 0;
            clearInterval(timer);
            document.getElementById('typingInput').disabled = false;
            document.getElementById('typingInput').value = '';
            document.getElementById('completionMessage').style.display = 'none';
            renderText();
            updateStats();
            document.getElementById('typingInput').focus();
        }

        function newText() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('typingSection').style.display = 'none';
            document.getElementById('completionMessage').style.display = 'none';
            document.getElementById('textInput').value = '';
            document.getElementById('typingInput').disabled = false;
            clearInterval(timer);
        }

        function pauseResume() {
            const btn = document.getElementById('pauseBtn');
            const input = document.getElementById('typingInput');
            if (isPaused) {
                isPaused = false;
                startTime = Date.now();
                timer = setInterval(updateStats, 100);
                btn.textContent = '[PAUSE]';
                input.disabled = false;
                input.focus();
            } else {
                isPaused = true;
                elapsedTime += Date.now() - startTime;
                clearInterval(timer);
                btn.textContent = '[RESUME]';
                input.disabled = true;
            }
        }

        // Listeners
        const typingInputEl = document.getElementById('typingInput');
        typingInputEl.addEventListener('input', handleTyping);
        typingInputEl.addEventListener('paste', (e) => e.preventDefault()); // optional: block paste
        typingInputEl.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart; const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 1;
                this.dispatchEvent(new Event('input'));
            }
        });
    // Extra listeners and helpers
        function placeCaretAtEnd(el) { const len = el.value.length; try { el.setSelectionRange(len, len); } catch(e) {} }
        typingInputEl.addEventListener('click', () => placeCaretAtEnd(typingInputEl));
        typingInputEl.addEventListener('keydown', (e) => {
            if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','PageUp','PageDown'].includes(e.key)) {
                e.preventDefault(); placeCaretAtEnd(typingInputEl);
            }
        });
        document.addEventListener('keydown', (e) => {
            const setupVisible = document.getElementById('setupSection').style.display !== 'none';
            const doneVisible = document.getElementById('completionMessage').style.display === 'block';
            if (e.key === 'Escape') { e.preventDefault(); pauseResume(); }
            else if (e.key === 'Enter') {
                if (setupVisible) { e.preventDefault(); startTyping(); }
                else if (doneVisible) { e.preventDefault(); resetTyping(); }
            }
        });
        // Persist text input to localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const ta = document.getElementById('textInput');
            try {
                const saved = localStorage.getItem('tp_text');
                if (saved) ta.value = saved;
            } catch(e) {}
            ta.addEventListener('input', (e) => { try { localStorage.setItem('tp_text', e.target.value); } catch(err) {} });
        });
    function saveSession(wpm, accuracy, timeMs) {
        try {
            const rec = { ts: Date.now(), wpm, accuracy, timeMs, chars: originalText.length };
            const existing = JSON.parse(localStorage.getItem('tp_sessions') || '[]');
            existing.push(rec);
            localStorage.setItem('tp_sessions', JSON.stringify(existing.slice(-20)));
        } catch(e) {}
    }
    function renderHistory() {
        const list = document.getElementById('historyList');
        if (!list) return;
        list.innerHTML = '';
        let arr = [];
        try { arr = JSON.parse(localStorage.getItem('tp_sessions') || '[]'); } catch(e) { arr = []; }
        if (arr.length === 0) {
            const li = document.createElement('li'); li.style.opacity = '0.7'; li.textContent = 'No prior sessions'; list.appendChild(li); return;
        }
        const recent = arr.slice(-10).reverse();
        recent.forEach(s => {
            const li = document.createElement('li');
            const mins = Math.floor(s.timeMs / 60000);
            const secs = Math.floor((s.timeMs % 60000) / 1000).toString().padStart(2, '0');
            const when = new Date(s.ts).toLocaleString();
            li.innerHTML = `<span>${when}</span><span>${s.wpm} WPM · ${s.accuracy}% · ${mins}:${secs}</span>`;
            list.appendChild(li);
        });
    }
    function clearHistory() { try { localStorage.removeItem('tp_sessions'); } catch(e) {} renderHistory(); }
    function copyResults() {
        const wpm = document.getElementById('finalWpm').textContent;
        const acc = document.getElementById('finalAccuracy').textContent;
        const time = document.getElementById('finalTime').textContent;
        const payload = `Typing Practice Result — WPM: ${wpm}, Accuracy: ${acc}, Time: ${time}`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(payload).catch(fallback);
        } else { fallback(); }
        function fallback() {
            const ta = document.createElement('textarea'); ta.value = payload; document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); } catch(e) {} document.body.removeChild(ta);
        }
    }

    </script>
</body>
</html>
